---
fontsize: 11pt
documentclass: article
bibliography: Endnote_lib.bib
csl: reference-style.csl
output:
  rmarkdown::pdf_document:
    fig_caption: yes
    keep_tex: yes
    includes:
      in_header: [preamble-latex.tex, preamble-latex3.tex]
---
## Supporting Information
All data and code is stored in an online repository (\url{www.github.com/paleo13/genetic.surrogates}) to replicate analyses in this study. See the \textit{README} file for instructions.


```{r, include=FALSE}
# set wd
knitr::opts_knit$set(root.dir=normalizePath('../..'))
```

```{r, include=FALSE}
# load .rda file
try(session::restore.session('data/final/results.rda'))

# set options
options(error=NULL)

# download basemap
data(countriesHigh)
countries.FPLY <- countriesHigh[
	countriesHigh$ADMIN %in% c(
		'Italy', 'Switzerland', 'France', 'Austria',
		'Germany', 'Slovenia', 'Croatia', 'Hungary',
		'Monaco', 'Germany', 'Slovakia', 'Czech Republic'
	)
,] %>% spFortify
grid.FPLY <- spFortify(grid.PLY)
grid.sub.FPLY <- spFortify(grid.sub.PLY)

# define ggplot2 color wheel function
gg_color_hue <- function(n) {
	hues <- seq(15, 375, length=n+1)
	hcl(h=hues, l=65, c=100)[1:n]
}
```

```{r, echo=FALSE, fig.width=9.5, fig.height=10, out.width='7.5in', out.height='8.5in', fig.cap=paste0('Species distributions. Squares represent planning units. For a given species, planning units that were found to be inhabited are denoted with bright blue. Note that \\textit{',gsub('\\_', '\\ ', missing.species),'} was omitted from analysis.')}
## plot map of species distributions
# fortify data
spp.grid.FPLY <- ldply(unique(spp.samples.DF$species), function(x) {
		z <- grid.FPLY[,c('long', 'lat', 'group', x),drop=FALSE]
		names(z)[4] <- 'presence'
		z$species <- gsub('\\_', ' ', x)
		return(z)
	}
) %>% mutate(presence=factor(c('absent', 'present')[presence+1]))

# plot species data
ggplot() +
	geom_polygon(data=countries.FPLY, aes(x=long, y=lat, group=group),
		fill='grey85', color='grey70') +
	geom_polygon(data=spp.grid.FPLY, aes(x=long, y=lat, 
		group=group, fill=presence), alpha=0.8, color='grey10') +
	theme_classic() +
	theme(
		axis.ticks=element_blank(), axis.text=element_blank(), axis.line=element_blank(), plot.margin = unit(c(0, 0, 0, 0), "lines"),
		strip.background = element_rect(fill='grey20'),
		strip.text = element_text(color='white', face='italic'),
		axis.title=element_blank()
	) +
		scale_fill_manual(name='Occupancy', values=c('absent'='#FC8D59', 'present'='#91CF60')) +
	coord_cartesian(
		xlim=buffered.range(grid.FPLY$long, 0),
		ylim=buffered.range(grid.FPLY$lat, 0)
	) +
	facet_wrap(~ species, ncol=4)
```

```{r, fig.width=15, fig.height=3, fig.cap='Climatic variation. Each panel depicts variation based on a different principle component (PC). Squares represent planning units. The color of each planning unit denotes the average PC value of pixels inside it. Planning units with more similar colors have more similar climate regimes.', echo=FALSE}
do.call(
	grid.arrange,
		append(
		llply(grep('^env\\_.*$', names(grid.DF), value=TRUE), function(x) {
			grid.FPLY$plot_title <- paste0('PC ', substr(x, nchar(x), nchar(x)))
			ggplot() +
				geom_polygon(data=countries.FPLY, aes(x=long, y=lat, group=group),
					fill='grey85', color='grey70') +
				geom_polygon(data=grid.FPLY, aes_string(x='long', y='lat', 
					group='group', fill=x), color='grey10') +
				theme_classic() +
				theme(
					axis.ticks=element_blank(), axis.text=element_blank(), axis.line=element_blank(), plot.margin = unit(c(0, 0, 0, 0), "lines"), axis.title=element_blank(),
					panel.border=element_rect(color='black', fill=NA, size=1),
					strip.background = element_rect(fill='grey20'),
					strip.text = element_text(color='white', size=5)
				) +
				coord_cartesian(
					xlim=buffered.range(grid.FPLY$long, 0),
					ylim=buffered.range(grid.FPLY$lat, 0)
				) +
				scale_fill_gradientn(name='',
					colors=brewer.pal(9, 'RdYlBu'),
					guide=guide_colorbar(ticks=element_line(color='black'), border=element_line(color='black'))
				) +
				facet_wrap(~ plot_title)
		}),
		list(ncol=4)
	)
)
```

```{r, echo=FALSE}
# prepare data
pop.probs.DF <- llply(
	seq_along(unique(spp.samples.DF$species)),
	function(i) {
		curr.pts <- filter(
			spp.sample.PTS@data,
			species==unique(spp.samples.DF$species)[i]
		) %>% mutate(
			Individual=seq_along(species)
		) 	
		curr.probs <- spp.StructureAnalysis.LST[[i]]@results@summary %>%
			as.data.frame() %>%
			mutate(
				species=unique(spp.samples.DF$species)[i],
				Individual=seq_along(species)) %>%
			gather(Population,Probability,-species,-Individual) %>%
			mutate(Population=as.numeric(gsub('V', '', Population, fixed=TRUE))) %>%
			left_join(curr.pts, by=c('species','Individual')) %>%
			mutate(species=gsub('_', ' ', species, fixed=TRUE)) %>%
			arrange(species,Individual,Population)
		return(curr.probs)
	}
) %>% do.call(what=rbind)
# create legend colors
legend.CHR <- `names<-`(
	gg_color_hue(n_distinct(pop.probs.DF$Population)),
	as.character(unique(pop.probs.DF$Population))
)
# create function
plot.spp.pop.probs <- function(i) {
	# init spp.samples
	prop <- 0.85
	curr.spp.DF <- filter(pop.probs.DF, species==unique(pop.probs.DF$species)[i])
	# create base map grob
	curr.GROB <- ggplot(data=curr.spp.DF) +
		geom_polygon(data=countries.FPLY, aes(x=long, y=lat, group=group),
			fill='grey85', color='grey75') +
		geom_polygon(data=grid.FPLY, aes_string(x='long', y='lat', 
			group='group'), fill='grey70', color='grey10') +
		guides(fill=guide_legend(title=''), color=guide_legend(title='')) +
		theme_classic() +
		theme(
			axis.title=element_blank(), axis.text=element_blank(),
			axis.line=element_blank(), axis.ticks=element_blank(),
			axis.ticks.length = unit(0, "cm"),
			legend.position = "none", panel.margin = unit(0, "lines"),
			plot.margin = unit(c(0, 0, 0, 0), "lines"),
			strip.background = element_rect(fill='grey20'),
			strip.text = element_text(color='white', face='italic', size=20),
			legend.text= element_text(size=20)
		) + 
		coord_cartesian(
			xlim=buffered.range(grid.FPLY$long, 0),
			ylim=buffered.range(grid.FPLY$lat, 0)
		) +
		scale_fill_manual(
			name='',
			values=legend.CHR[seq_len(n_distinct(curr.spp.DF$Population))]
		)
	# create header grob
	curr.GROBH <- ggplot() +
			geom_text(aes(x=0,y=0,label=species),
				data=curr.spp.DF[1,,drop=FALSE],
				color='white', fontface='italic', size=4) +
		theme_classic() +
		theme(
			axis.title=element_blank(), axis.text=element_blank(),
			axis.line=element_blank(), axis.ticks=element_blank(),
			axis.ticks.length = unit(0, "cm"),
			legend.position = "none", panel.margin = unit(0, "lines"),
			plot.margin = unit(c(0, 0, 0, 0), "lines"),
			panel.background=element_rect(fill='grey20')
		) +
		coord_cartesian(xlim=c(-1,1), ylim=c(-1,1))
	# create bbox object
	bbox <- c(ggplot_build(curr.GROB)$panel$ranges[[1]]$x.range,
		ggplot_build(curr.GROB)$panel$ranges[[1]]$y.range)
		names(bbox) <- c('ll.lon', 'ur.lon', 'll.lat', 'ur.lat')
	# render grob
	grid.newpage()
	pushViewport(viewport(layout=grid.layout(2,1, heights=unit(c(1-prop, prop), "npc"))))
	print(curr.GROBH, vp=viewport(layout.pos.row=1, layout.pos.col=1))
	print(curr.GROB, vp=viewport(layout.pos.row=2, layout.pos.col=1))
	# add in pies
	for (j in unique(curr.spp.DF$cell)) {
		# init
		curr.cell.DF <- filter(curr.spp.DF, cell==j) %>% 
			group_by(cell, Population) %>%
			summarize(
				grid.longitude=mean(grid.longitude), 
				grid.latitude=mean(grid.latitude),
				Probability=mean(Probability)
			) %>% data.frame()
		curr.lon <- (curr.cell.DF$grid.longitude[1]-bbox['ll.lon'])/abs(bbox['ur.lon']-bbox['ll.lon'])
		curr.lat <- ((curr.cell.DF$grid.latitude[1]-bbox['ll.lat'])/abs(bbox['ur.lat']-bbox['ll.lat']))*prop
		# create pie chart for individual
		curr.pie <- ggplot(curr.cell.DF, aes(x="", y=Probability, fill=factor(Population))) +
			geom_bar(width=0.75, color='grey20', stat='identity') +
			coord_polar(theta='y') +
			theme(
				line = element_blank(), rect = element_blank(), 
				text = element_blank(), axis.ticks.length = unit(0, "cm"),
				legend.position = "none", panel.margin = unit(0, "lines"),
				plot.margin = unit(c(0, 0, 0, 0), "lines"), complete = TRUE
			) +
			scale_fill_manual(
				name='',
				values=legend.CHR[seq_len(n_distinct(curr.spp.DF$Population))]
			)
		# render pie
		print(curr.pie, vp=viewport(x=curr.lon, y=curr.lat, width=0.075, height=0.075))
	}
}
```


```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_',' ',unique(spp.samples.DF$species)[1], fixed=TRUE),'} populations. Squares denote planning units. Pie charts denote quadrats where individuals were sampled, and colors denote the average probability that individuals in the quadrat belong to different populations on average.')}
plot.spp.pop.probs(1)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[2],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (2 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(2)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[3],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (3 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(3)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[4],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (4 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(4)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[5],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (5 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(5)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[6],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (6 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(6)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[7],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (7 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(7)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[8],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (8 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(8)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[9],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (9 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(9)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[10],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (10 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(10)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[11],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (12 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(11)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[12],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (12 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(12)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[13],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (13 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(13)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[14],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (14 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(14)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[15],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (15 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(15)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[16],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (16 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(16)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[17],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (17 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(17)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[18],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (18 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(18)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[19],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (19 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(19)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[20],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (20 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(20)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[21],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (21 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(21)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[22],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (22 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(22)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[23],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (23 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(23)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[24],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (24 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(24)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[25],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (25 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(25)
```

```{r, echo=FALSE, fig.width=3, fig.height=2, fig.cap=paste0('Distribution of \\textit{',gsub('_', ' ',unique(spp.samples.DF$species)[26],fixed=TRUE),'} populations. See Figure S3 caption for conventions.')}
if (26 <= general.params.LST[[MODE]]$n.spp) plot.spp.pop.probs(26)
```

```{r, echo=FALSE}
plot.spp.nmds <- function(i) {
	## prepare data
	# get vector of adaptive and neutral column names
	adapt.col <- grep(
		paste0(unique(spp.samples.DF$species)[i], '_adaptive_d'),
		names(grid.FPLY), value=TRUE, fixed=TRUE
	)
	neutral.col <- grep(
		paste0(unique(spp.samples.DF$species)[i], '_neutral_d'),
		names(grid.FPLY), value=TRUE, fixed=TRUE
	)
	# skip species if not used in analysis
	curr.FPLY <- grid.FPLY[,
		c(adapt.col, neutral.col,
		'long','lat','group'),drop=FALSE]
	curr.FPLY <- curr.FPLY[which(!is.na(curr.FPLY[[1]])),]
	curr.FPLY <- curr.FPLY %>% gather(d, value, contains('adaptive'), contains('neutral')) %>% mutate(
		d=gsub(paste0(unique(spp.samples.DF$species)[i], '_'), '', d, fixed=TRUE),
		d=gsub('_', ' ', d, fixed=TRUE)
	)
	for (j in seq_len(length(adapt.col)+length(neutral.col)))
		curr.FPLY[['d']] <- gsub(as.character(j), paste0('(', j, ')'), curr.FPLY[['d']], fixed=TRUE)
	curr.FPLY <- curr.FPLY %>% mutate(d=factor(gsub(' d(', ' (', d, fixed=TRUE)))
	# make plot
	curr.GROBS <- llply(unique(curr.FPLY$d), function(x) {
		ggplot() +
			geom_polygon(data=countries.FPLY, aes(x=long, y=lat, group=group),
				fill='grey85', color='grey70') +
			geom_polygon(data=filter(curr.FPLY, d==x), aes_string(x='long', y='lat', 
				group='group', fill='value'), color='grey10') +
			theme_classic() +
			theme(
				axis.ticks=element_blank(), axis.text=element_blank(), axis.line=element_blank(), plot.margin = unit(c(0, 0, 0, 0), "lines"), axis.title=element_blank(),
				panel.border=element_rect(color='black', fill=NA, size=1),
				strip.background = element_rect(fill='grey20'),
				strip.text = element_text(color='white', size=20)
			) +
			coord_cartesian(
				xlim=buffered.range(grid.FPLY$long, 0),
				ylim=buffered.range(grid.FPLY$lat, 0)
			) +
			scale_fill_gradientn(name='',
				colors=brewer.pal(9, 'RdYlBu'),
				guide=guide_colorbar(ticks=element_line(color='black'),
					border=element_line(color='black'), barheight=unit(7, 'cm'))
			) + facet_wrap(~d)
	})
	do.call(grid.arrange, append(curr.GROBS, list(ncol=3)))
	invisible()
}

calc.fig.height <- function(i) {
	# init
	adapt.col <- paste0(unique(spp.samples.DF$species)[i], '_adaptive_d1')
	neutral.col <- paste0(unique(spp.samples.DF$species)[i], '_neutral_d1')
	n.plots <- 0 
	# count adaptive plot
	if (adapt.col %in% names(grid.FPLY))
		n.plots <- n.plots + spp.nmds.LST[[i]][['adaptive']]$ndim
	# count neutral plot
	if (neutral.col %in% names(grid.FPLY))
		n.plots <- n.plots + spp.nmds.LST[[i]][['neutral']]$ndim
	# exports
	return((((n.plots-1) %/% 3)+1) * 2.5)
}

calc.fig.width <- function(i) {
	# init
	adapt.col <- paste0(unique(spp.samples.DF$species)[i], '_adaptive_d1')
	neutral.col <- paste0(unique(spp.samples.DF$species)[i], '_neutral_d1')
	n.plots <- 0 
	# count adaptive plot
	if (adapt.col %in% names(grid.FPLY))
		n.plots <- n.plots + spp.nmds.LST[[i]][['adaptive']]$ndim
	# count neutral plot
	if (neutral.col %in% names(grid.FPLY))
		n.plots <- n.plots + spp.nmds.LST[[i]][['neutral']]$ndim
	# exports
	if (n.plots > 3) n.plots <- 3
	return((10/3) * n.plots)
}

is.speciesPlottable <- function(i) {
	return(i <= general.params.LST[[MODE]]$n.spp & (!unique(spp.samples.DF$species)[i] %in% missing.species) & !is.na(unique(spp.samples.DF$species)[i]))
}
```

```{r, echo=FALSE, fig.width=calc.fig.width(1), fig.height=calc.fig.height(1), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[1]),'}. Each panel shows a different dimension of the variation as indicated by its title. Squares represent planning units. The color of each planning unit panel corresponds to the average ordinated values associated with individuals sampled inside it. No indiviudals of this species were found inside the gray planning units.')}
if (is.speciesPlottable(1)) plot.spp.nmds(1)
 ```

```{r, echo=FALSE, fig.width=calc.fig.width(2), fig.height=calc.fig.height(2), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[2]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(2)) plot.spp.nmds(2)
```

```{r, echo=FALSE, fig.width=calc.fig.width(3), fig.height=calc.fig.height(3), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[3]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(3)) plot.spp.nmds(3)
```

```{r, echo=FALSE, fig.width=calc.fig.width(4), fig.height=calc.fig.height(4), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[4]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(4)) plot.spp.nmds(4)
```

```{r, echo=FALSE, fig.width=calc.fig.width(5), fig.height=calc.fig.height(5), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[5]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(5)) plot.spp.nmds(5)
```

```{r, echo=FALSE, fig.width=calc.fig.width(6), fig.height=calc.fig.height(6), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[6]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(6)) plot.spp.nmds(6)
```

```{r, echo=FALSE, fig.width=calc.fig.width(7), fig.height=calc.fig.height(7), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[7]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(7)) plot.spp.nmds(7)
```

```{r, echo=FALSE, fig.width=calc.fig.width(8), fig.height=calc.fig.height(8), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[8]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(8)) plot.spp.nmds(8)
```

```{r, echo=FALSE, fig.width=calc.fig.width(9), fig.height=calc.fig.height(9), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[9]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(9)) plot.spp.nmds(9)
```

```{r, echo=FALSE, fig.width=calc.fig.width(10), fig.height=calc.fig.height(10), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[10]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(10)) plot.spp.nmds(10)
```

```{r, echo=FALSE, fig.width=calc.fig.width(11), fig.height=calc.fig.height(11), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[11]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(11)) plot.spp.nmds(11)
```

```{r, echo=FALSE, fig.width=calc.fig.width(12), fig.height=calc.fig.height(12), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[12]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(12)) plot.spp.nmds(12)
```

```{r, echo=FALSE, fig.width=calc.fig.width(13), fig.height=calc.fig.height(13), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[13]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(13)) plot.spp.nmds(13)
```

```{r, echo=FALSE, fig.width=calc.fig.width(14), fig.height=calc.fig.height(14), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[14]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(14)) plot.spp.nmds(14)
```

```{r, echo=FALSE, fig.width=calc.fig.width(15), fig.height=calc.fig.height(15), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[15]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(15)) plot.spp.nmds(15)
```

```{r, echo=FALSE, fig.width=calc.fig.width(16), fig.height=calc.fig.height(16), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[16]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(16)) plot.spp.nmds(16)
```

```{r, echo=FALSE, fig.width=calc.fig.width(17), fig.height=calc.fig.height(17), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[17]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(17)) plot.spp.nmds(17)
```

```{r, echo=FALSE, fig.width=calc.fig.width(18), fig.height=calc.fig.height(18), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[18]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(18)) plot.spp.nmds(18)
```

```{r, echo=FALSE, fig.width=calc.fig.width(19), fig.height=calc.fig.height(19), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[19]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(19)) plot.spp.nmds(19)
```

```{r, echo=FALSE, fig.width=calc.fig.width(20), fig.height=calc.fig.height(20), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[20]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(20)) plot.spp.nmds(20)
```

```{r, echo=FALSE, fig.width=calc.fig.width(21), fig.height=calc.fig.height(21), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[21]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(21)) plot.spp.nmds(21)
```

```{r, echo=FALSE, fig.width=calc.fig.width(22), fig.height=calc.fig.height(22), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[22]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(22)) plot.spp.nmds(22)
```

```{r, echo=FALSE, fig.width=calc.fig.width(23), fig.height=calc.fig.height(23), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[23]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(23)) plot.spp.nmds(23)
```

```{r, echo=FALSE, fig.width=calc.fig.width(24), fig.height=calc.fig.height(24), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[24]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(24)) plot.spp.nmds(24)
```

```{r, echo=FALSE, fig.width=calc.fig.width(25), fig.height=calc.fig.height(25), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[25]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(25)) plot.spp.nmds(25)
```

```{r, echo=FALSE, fig.width=calc.fig.width(26), fig.height=calc.fig.height(26), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[26]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(26)) plot.spp.nmds(26)
```

```{r, echo=FALSE, fig.width=calc.fig.width(27), fig.height=calc.fig.height(27), fig.cap=paste0('Distribution of adaptive and neutral genetic variation in \\textit{',gsub('\\_', ' ', unique(spp.samples.DF$species)[27]),'}. See Figure S6 caption for conventions.')}
if (is.speciesPlottable(27)) plot.spp.nmds(27)
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=(2.5*4), fig.cap='The relationship between the proportion of adaptive genetic variation secured in a prioritizaiton and the proportion of environmental variation it also secures. Points represent values associated with randomly generated prioritizations. Blue lines indicate average trends computed using a generalised linear model with a logit link. Each panel shows data for a different species.'}
# format data
curr.DF <- env.surrogacy.DF %>% filter(!is.na(genetic.held)) %>% mutate(Species=gsub('_', ' ', Species))
curr.DF2 <- env.surrogate.spp.DF %>% filter(!is.na(r2CU)) %>% mutate(Species=gsub('_', ' ', Species))
curr.DF2$R2_repr <- round(curr.DF2$r2CU,2)
curr.DF2$R2_repr <- sapply(curr.DF2$R2_repr, function(x) {as.character(as.expression(substitute(~~italic(R)^2~"="~r2, list(r2=x))))})
curr.DF2$surrogate.held <- 0
curr.DF2$genetic.held <- 0.9

# make plot
suppressWarnings(
	ggplot(aes(x=surrogate.held, y=genetic.held), data=curr.DF) +
		theme_classic() +
		theme(strip.background=element_rect(fill='grey20'), strip.text=element_text(color='white', face='italic', size=12),
			panel.margin.x=unit(1, 'lines')) +
		xlab('Environmental variation secured (%)') +
		ylab('Adaptive genetic variation secured (%)') +
		geom_point(fill='transparent') +
		suppressWarnings(stat_smooth(method='glm', method.args=list(family='binomial'), fullrange=TRUE,
			se=FALSE, fill='blue', alpha=0.8)) +
		geom_text(aes(label=R2_repr), data=curr.DF2, parse=TRUE, hjust=0, size=8, color='darkred') +
		facet_wrap(~ Species, ncol=4)
)
```

```{r, include=FALSE}
calc.fig.height3 <- function(x) {
	return((((x-1) %/% 4)+1)*1.5)
}

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=calc.fig.height3(n_distinct(geo.surrogacy.DF$Species)), fig.cap='The relationship between the proportion of neutral genetic variation secured in a prioritizaiton and the proportion of geographic variation it also secures. Conventions are detailed in Figure S55.'}
# format data
curr.DF <- geo.surrogacy.DF %>% filter(!is.na(genetic.held)) %>% mutate(Species=gsub('_', ' ', Species))
curr.DF2 <- geo.surrogate.spp.DF %>% filter(!is.na(r2CU)) %>% mutate(Species=gsub('_', ' ', Species))
curr.DF2$R2_repr <- round(curr.DF2$r2CU,2)
curr.DF2$R2_repr <- sapply(curr.DF2$R2_repr, function(x) {as.character(as.expression(substitute(~~italic(R)^2~"="~r2, list(r2=x))))})
curr.DF2$surrogate.held <- 0
curr.DF2$genetic.held <- 0.9

# make plot
suppressWarnings(
	ggplot(aes(x=surrogate.held, y=genetic.held), data=curr.DF) +
		theme_classic() +
		theme(strip.background=element_rect(fill='grey20'), strip.text=element_text(color='white', face='italic', size=12),
			panel.margin.x=unit(1, 'lines')) +
		xlab('Geographic variation secured (%)') +
		ylab('Neutral genetic variation secured (%)') +
		geom_point(fill='transparent') +
		suppressWarnings(stat_smooth(method='glm', method.args=list(family='binomial'), fullrange=TRUE,
			se=FALSE, fill='blue', alpha=0.8)) +
		geom_text(aes(label=R2_repr), data=curr.DF2, parse=TRUE, hjust=0, size=8, color='darkred') +
		facet_wrap(~ Species, ncol=4)
)
```

```{r, echo=FALSE, results='asis'}
## make results table showing Eigen values
curr.file <- tempfile(fileext='.tex')
pca.DF[['Eigen Value']] <- c(round(pca.DF[['Eigen Value']][-19],2), pvalString(pca.DF[['Eigen Value']][19], digits=2))
pca.DF[['Variation explained (%)']] <- c(round(pca.DF[['Variation explained (%)']][1:3],2), pvalString(pca.DF[['Variation explained (%)']][-1:-3], digits=2))
pca.DF[['Accumulative variation explained (%)']] <- as.character(round(pca.DF[['Accumulative variation explained (%)']],2))
x <- pca.DF %>%
	latex(file=curr.file, 
		rowname=NULL, first.hline.double=FALSE, booktabs=TRUE, col.just=rep('c', ncol(pca.DF)), here=TRUE,
		colheads=c("\\parbox[t]{2.5cm}{\\centering \\bfseries{Principle Component}}", "\\parbox[t]{2cm}{\\centering \\bfseries{Eigen value}}",
			"\\parbox[t]{3cm}{\\centering \\bfseries{Variation explained (\\%)}}", "\\parbox[t]{4.5cm}{\\centering \\bfseries{Cumulative variation explained (\\%)}}"),
		caption=paste0('Summary of principle components analysis (PCA) on bioclimatic variation across the study area. The first ',as.character(as.english(surrogate.params.LST[[MODE]]$number.components)),' principle components (PCs) were used for subsequent analysis.')
	)
readLines(curr.file)[-1] %>% paste0(collapse='\n') %>% 
	gsub(pattern='toprule', replacement='toprule[1pt]', fixed=TRUE) %>%
	gsub(pattern='bottomrule', replacement='bottomrule[1pt]', fixed=TRUE) %>%
	cat()
```

```{r, echo=FALSE, results='asis'}
adaptive.spp.nmds.summary.DF <- spp.nmds.summary.DF %>% filter(Loci=='adaptive') %>% mutate(Stress=as.character(round(Stress,3))) %>% mutate(Stress=replace(Stress, Stress=='0', '< 0.001'))
neutral.spp.nmds.summary.DF <- spp.nmds.summary.DF %>% filter(Loci=='neutral') %>% mutate(Stress=as.character(round(Stress,3))) %>% mutate(Stress=replace(Stress, Stress=='0', '< 0.001'))
names(adaptive.spp.nmds.summary.DF)[2:5] <- paste0('adaptive.', names(adaptive.spp.nmds.summary.DF)[2:5])
names(neutral.spp.nmds.summary.DF)[2:5] <- paste0('neutral.', names(neutral.spp.nmds.summary.DF)[2:5])
spp.nmds.summary.DF2 <- full_join(adaptive.spp.nmds.summary.DF, neutral.spp.nmds.summary.DF, by='Species')
spp.nmds.summary.DF2$adaptive.Stress[which(spp.nmds.summary.DF2$adaptive.Converged)] <- paste0('\\bfseries{', spp.nmds.summary.DF2$adaptive.Stress[which(spp.nmds.summary.DF2$adaptive.Converged)],'}')
spp.nmds.summary.DF2$neutral.Stress[which(spp.nmds.summary.DF2$neutral.Converged)] <- paste0('\\bfseries{', spp.nmds.summary.DF2$neutral.Stress[which(spp.nmds.summary.DF2$neutral.Converged)],'}')
spp.nmds.summary.DF2 <- spp.nmds.summary.DF2 %>%
	mutate(blank='') %>%
	select(Species, adaptive.k:adaptive.Stress, neutral.k:neutral.Stress)
curr.file <- tempfile(fileext='.tex')
x <- spp.nmds.summary.DF2 %>%
	latex(
		file=curr.file,
		rowname=NULL, first.hline.double=FALSE, booktabs=TRUE, col.just=rep('c', 5),
		cgroup=c('', 'Adaptive', 'Neutral'), n.cgroup=c(1, 2, 2),
		colheads=c('\\bfseries{Species}', 'K', 'Stress', 'K', 'Stress'), here=TRUE,
		caption='Summary of non-metric multi-dimensional scaling (NMDS) analyses on genetic variation for each species. The analyses were used to identify the main graondients of variation in binary adaptive and neutral loci data. Bold stress values indicate NMDS analyses that have converged.'
	)
readLines(curr.file)[-1] %>% paste0(collapse='\n') %>% 
	gsub(pattern='\\cline{1-', replacement='\\cline{3-4} \\cline{6-', fixed=TRUE) %>% 
	gsub(pattern='toprule', replacement='toprule[1pt]', fixed=TRUE) %>%
	gsub(pattern='bottomrule', replacement='bottomrule[1pt]', fixed=TRUE) %>%
	cat()
```

```{r, echo=FALSE, results='asis'}
curr.file <- tempfile(fileext='.tex')
x <- surrogate.spp.DF %>%
	mutate(
		Environmental.z = paste(round(Environmental.estimate,2), '$\\pm$', round(Environmental.std.error,2)),
		Geographic.z = paste(round(Geographic.estimate,2), '$\\pm$', round(Geographic.std.error,2)),
		Species = paste0('\\textit{', gsub('_', ' ', Species, fixed=TRUE), '}')) %>%
	mutate(
		Environmental.z=replace(Environmental.z, grepl('NA', Environmental.z, fixed=TRUE),''),
		Geographic.z=replace(Geographic.z, grepl('NA', Geographic.z, fixed=TRUE),'')
	) %>%
	select(Species, Environmental.z, Environmental.p.value, Environmental.r2CU,
		Geographic.z, Geographic.p.value, Geographic.r2CU) %>%
	latex(file=curr.file, 
		cgroup=c('', 'Environmental', 'Geographic'), n.cgroup=c(1, 3, 3), col.just=rep('c', 7),
		digits=2, rowname=NULL, first.hline.double=FALSE, booktabs=TRUE, here=TRUE,
		colheads=c('\\bfseries{Species}', '$\\textit{Z}$', '\\textit{P}', '$R^2$', '$\\textit{Z}$', '\\textit{P}', '$R^2$'),
		caption='Summary of post-hoc analyses on generalized linear models. Briefly, two generalized linear models were fit to correlate the proportion of adaptive genetic variation and environmental variation secured, and the proportion of neutral genetic variation and geographic variation secured in a prioritization. These models also included a predictor variable indicating the species for which the prioritizations were generated, and an interaction term. A post-hoc analysis was conducted to determine if the slopes for each species were significantly different to zero (detailed in the \\textit{Z} and \\textit{P} columns). All tests used a single degree of freedom. Cragg and Uhler\'s pseudo-R$^2$ values were calculated to show the proportion of variation explained by the slopes for each species ($R^2$ column).'
	)
readLines(curr.file)[-1] %>% paste0(collapse='\n') %>% 
	gsub(pattern='\\cline{1-', replacement='\\cline{2-5} \\cline{7-', fixed=TRUE) %>% 
	gsub(pattern='ulticolumn{1}{c}{$R^2$}\\tabularnewline', replacement='ulticolumn{1}{c}{$R^2$}\\T\\B\\tabularnewline', fixed=TRUE) %>% 
	gsub(pattern='toprule', replacement='toprule[1pt]', fixed=TRUE) %>%
	gsub(pattern='bottomrule', replacement='bottomrule[1pt]', fixed=TRUE) %>%
	cat()
```

```{r, echo=FALSE}
write.table(loci_classification.DF, 'article/Table_S4.csv', sep=',', row.names=FALSE)
```


