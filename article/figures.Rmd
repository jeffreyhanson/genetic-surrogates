---
fontsize: 11pt
documentclass: article
bibliography: Endnote_lib.bib
csl: reference-style.csl
output:
  rmarkdown::pdf_document:
    fig_caption: yes
    includes:
      in_header: [preamble-latex.tex, preamble-latex2.tex]
---

```{r, include=FALSE}
# set wd
setwd('..')

# load .rda files
load('results/results.rda')

# load packages
source('R/analysis/00-initialization.R')

# set options
options(error=NULL)
```

## Figures

```{r, echo=FALSE, fig.width=6, fig.height=3, fig.cap='Summary of single species prioritizations. Single species prioritizations were generated using amount-based targets, amount-based and surrogate-based targets, and amount-based and genetic-based targets for each species. Violin plots show the performance of prioritizations generated using these three sets of targets. Points denote the values associated with each prioritization. Letters denote significant differences ($P < 0.05$).'}
# prepare data for plotting
single.spp.PDF <- expand.grid(
	Prioritisation=unique(single.spp.SDF$Prioritisation),
	Metric=unique(single.spp.SDF$Metric)
) %>% mutate(
	letters=toupper(cld(single.spp.MCP)$mcletters$Letters),
	letter.height=max(single.spp.SDF$value)+(diff(range(single.spp.SDF$value))*0.1)
)
# make plot
ggplot(aes(x=Metric,y=value,fill=Prioritisation),
	data=single.spp.SDF) +
	geom_violin(position=position_dodge(0.9)) +
	geom_point(alpha=0.2,position=position_jitterdodge(dodge.width=0.9, jitter.width=0.25)) +
	geom_text(aes(x=Metric, y=letter.height, label=letters),
		data=single.spp.PDF, position=position_dodge(0.9)) +
	scale_fill_manual(name='Prioritisation',
		values=c('grey80','grey50','grey20')) +
	ylab('Genetic variation secured (%)') +
	xlab('') +
	theme_classic()
```

```{r, echo=FALSE, fig.width=8, fig.height=3, fig.cap='Multi-species prioritizations. Panel (a) shows the prioritization generated for using just amount-based targets. Panel (b) shows the prioritization generated using amount-based and surrogate based targets. Panel (c) shows the prioritization generated using amount-based and genetic-based targets.'}
# download basemap
data(countriesHigh)
countries.FPLY <- countriesHigh[
	countriesHigh$ADMIN %in% c(
		'Italy', 'Switzerland', 'France', 'Austria',
		'Germany', 'Slovenia', 'Croatia', 'Hungary',
		'Monaco', 'Germany', 'Slovakia', 'Czech Republic'
	)
,] %>% spFortify
# prepare data for plotting
multi.spp.grid.FPLY <- grid.PLY
for (i in seq_along(multi.spp.prioritisations))
	multi.spp.grid.FPLY@data[[paste0('v',i)]] <- selections(multi.spp.prioritisations[[i]])
multi.spp.grid.FPLY <- spFortify(multi.spp.grid.FPLY)
# make maps
do.call(
	grid.arrange,
	append(
		llply(
			seq_along(multi.spp.prioritisations),
			function(i) {
				ggplot() +
					geom_polygon(data=countries.FPLY, aes(x=long, y=lat, group=group),
						fill='grey20', color='grey80') +
					geom_polygon(data=multi.spp.grid.FPLY, aes_string(x='long', y='lat', 
						group='group', fill=paste0('v',i)),
						alpha=0.8, color='grey10') +
					guides(fill=guide_legend(title=' ')) +
					theme_classic() +
					theme(axis.ticks=element_blank(), axis.text=element_blank(),
						plot.margin=unit(c(0,0,0,0),'cm'), axis.line=element_blank(),
						legend.position='none') +
					coord_cartesian(
						xlim=buffered.range(multi.spp.grid.FPLY$long, 0.05),
						ylim=buffered.range(multi.spp.grid.FPLY$lat, 0.05)
					) +
					xlab('') +
					ylab('') +
					annotate('text',
						x=min(multi.spp.grid.FPLY$long)+diff(range(multi.spp.grid.FPLY$long)*0.1),
						y=min(multi.spp.grid.FPLY$lat)+diff(range(multi.spp.grid.FPLY$lat)*1.01),
						label=letters[i], hjust=1, vjust=1, color='white', size=8)
			}
		),
		list(nrow=1)
	)
)
```

```{r, echo=FALSE, fig.width=6, fig.height=3, fig.cap='Summary of multi-species prioritizations. Three prioritizations were generated using amount-based targets, amount-based and surrogate-based targets, and amount-based and genetic-based targets for each species. Data shows the performance of these prioritizations based on how much genetic variation they explain. See Figure 1 caption for conventions.'}
# prepare data for plotting
multi.spp.PDF <- expand.grid(
	Prioritisation=unique(multi.spp.SDF$Prioritisation),
	Metric=unique(multi.spp.SDF$Metric)
) %>% mutate(
	letters=toupper(cld(multi.spp.MCP)$mcletters$Letters),
	letter.height=max(multi.spp.SDF$value)+(diff(range(multi.spp.SDF$value))*0.1)
)
# make plot
ggplot(aes(x=Metric,y=value,fill=Prioritisation),
	data=multi.spp.SDF) +
	geom_violin(position=position_dodge(0.9)) +
	geom_point(alpha=0.2,position=position_jitterdodge(dodge.width=0.9, jitter.width=0.25)) +
	geom_text(aes(x=Metric, y=letter.height,label=letters),
		data=multi.spp.PDF, position=position_dodge(0.9)) +
	scale_fill_manual(name='Prioritisation',
		values=c('grey80','grey50','grey20')) +
	ylab('Genetic variation secured (%)') +
	xlab('') +
	theme_classic()
```

```{r, echo=FALSE, fig.width=8, fig.height=3, fig.cap='The relationship between surrogates and genetic variation secured in prioritizations. The left panel shows the relationship between environmental surrogates and adaptive genetic variation, and the right for geographic surrogates and neutral genetic variation. Transparent gray lines denote trneds for each species, and black lines show general trends across all species.'}
### prepare data frames for plotting
## environmental vs adaptive
# random effects
env.correlation.RPDF <- expand.grid(Surrogate.target=seq(min(env.correlation.DF$Surrogate.target), max(env.correlation.DF$Surrogate.target), length.out=100),
	Species=unique(env.correlation.DF$Species))
env.correlation.RPDF$r.ranef <- fixef(env.correlation.NLMM)[[1]] + ranef(env.correlation.NLMM)$Species$r[env.correlation.RPDF$Species]
env.correlation.RPDF$fit <- 0 + (1 - 0) * (1 - exp(- env.correlation.RPDF$r.ranef * env.correlation.RPDF$Surrogate.target))
# fixed effects
env.correlation.FPDF <- data.frame(Surrogate.target=seq(min(env.correlation.DF$Surrogate.target), max(env.correlation.DF$Surrogate.target), length.out=100))
env.correlation.FPDF$fit <- 0 + (1 - 0) * (1 - exp(-fixef(env.correlation.NLMM) * env.correlation.FPDF$Surrogate.target))

## geographic vs neutral
# random effects
geo.correlation.RPDF <- expand.grid(Surrogate.target=seq(min(geo.correlation.DF$Surrogate.target), max(geo.correlation.DF$Surrogate.target), length.out=100),
	Species=unique(geo.correlation.DF$Species))
geo.correlation.RPDF$r.ranef <- fixef(geo.correlation.NLMM)[[1]] + ranef(geo.correlation.NLMM)$Species$r[geo.correlation.RPDF$Species]
geo.correlation.RPDF$fit <- 0 + (1 - 0) * (1 - exp(- geo.correlation.RPDF$r.ranef * geo.correlation.RPDF$Surrogate.target))
# fixed effects
geo.correlation.FPDF <- data.frame(Surrogate.target=seq(min(geo.correlation.DF$Surrogate.target), max(geo.correlation.DF$Surrogate.target), length.out=100))
geo.correlation.FPDF$fit <- 0 + (1 - 0) * (1 - exp(-fixef(geo.correlation.NLMM) * geo.correlation.FPDF$Surrogate.target))

### make plots
p1 <- ggplot() +
	geom_point(aes(x=Surrogate.target, y=adaptive.held), data=env.correlation.DF) +
	geom_line(aes(x=Surrogate.target,y=fit,group=Species), data=env.correlation.RPDF, alpha=0.3) +
	geom_line(aes(x=Surrogate.target,y=fit), data=env.correlation.FPDF, size=1.5) +
	xlab('Environmental variation secured (%)') +
	ylab('Adaptive genetic\nvariation secured (%)') +
	theme_classic()
p2 <- ggplot() +
	geom_point(aes(x=Surrogate.target, y=neutral.held), data=geo.correlation.DF) +
	geom_line(aes(x=Surrogate.target,y=fit,group=Species), data=geo.correlation.RPDF, alpha=0.3) +
	geom_line(aes(x=Surrogate.target,y=fit), data=geo.correlation.FPDF, size=1.5) +
	xlab('Geographic variation secured (%)') +
	ylab('Neutral genetic\nvariation secured (%)') +
	theme_classic()
grid.arrange(p1, p2, nrow=1)
```
 
