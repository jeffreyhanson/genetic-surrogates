---
fontsize: 11pt
documentclass: article
bibliography: Endnote_lib.bib
csl: reference-style.csl
output:
  rmarkdown::pdf_document:
    fig_caption: yes
    keep_tex: yes
    includes:
      in_header: [preamble-latex.tex, preamble-latex2.tex]
---

```{r, include=FALSE}
# set wd
setwd('..')

# load .rda file
try(session::restore.session('results/results.rda'))

# set options
options(error=NULL)
```

## Figures

```{r, echo=FALSE, fig.width=8, fig.height=3, fig.cap='The relationship between surrogates and genetic variation secured in prioritizations. Panel (a) shows the relationship between environmental surrogates and adaptive genetic variation. Panel (b) shows that for geographic surrogates and neutral genetic variation. Transparent gray lines denote trends for each species, and black lines show general trends across all species.'}
### prepare data frames for plotting
#env.correlation.PDF <- filter(correlation.DF, Type='Environmental')
#
#%>% left_join(
#		data.frame(
#			letter=unname(toupper(cld(full.model.GLHT)$mcletters$Letters)),
#			Combination=as.character(names(toupper(cld(full.model.GLHT)$mcletters$Letters)))
#		) %>% mutate(Combination=as.character(Combination)),
#		by='Combination'
#	) %>% data.frame()


#geo.correlation.PDF <- filter(correlation.DF, Type='Geographic')
### make plots
#suppressWarnings({
#	p1 <- ggplot() +
#		geom_boxplot(aes(x=Surrogate.target, y=genetic.held, color=Method, group=Method), data=env.correlation.DF) +
#		geom_text(aes(x=Surrogate.target, y=letter.height, label=letter),
#			data=results.PDF, position=position_dodge(0.9)) +
#		geom_text(aes(x=0.6, y=1.03, label='(a)')) +
#		xlab('Environmental variation secured (%)') +
#		ylab('Adaptive genetic\nvariation secured (%)') +
#		theme_classic()
#	p2 <- ggplot() +
#		geom_boxplot(aes(x=Surrogate.target, y=neutral.held, color=Method), data=geo.correlation.DF) +
#		geom_text(aes(x=Surrogate.target, y=letter.height, label=letter),
#			data=results.PDF, position=position_dodge(0.9)) +
#		geom_text(aes(x=0.6, y=1.03, label='(b)')) +
#		xlab('Geographic variation secured (%)') +
#		ylab('Neutral genetic\nvariation secured (%)') +
#		theme_classic()
#	grid.arrange(p1, p2, nrow=1)
# })


plot(1)

```


```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=5, fig.height=5, fig.cap='Planning unit selection frequencies. The top row of panels (a, b, c) show single-species prioritizations generated assuming equal costs. The middle row of panels (d, e, f) show multi-species prioritizations generated assuming equal costs. The bottom row of panels (g, h, i) show multi-species generated using opportunity costs. The left column of panels (a, d, g) show prioritizations generated using only amount-based targets. The middle column of panels (b, e, h) show prioritizations generated using amount- and surrogate-based targets. The right column of panels (c, f, i) show prioritizations generated using amount- and genetic-based targets.'}
# download basemap
data(countriesHigh)
countries.FPLY <- countriesHigh[
	countriesHigh$ADMIN %in% c(
		'Italy', 'Switzerland', 'France', 'Austria',
		'Germany', 'Slovenia', 'Croatia', 'Hungary',
		'Monaco', 'Germany', 'Slovakia', 'Czech Republic'
	)
,] %>% spFortify
# prepare data for plotting
grid.FPLY <- grid.PLY
for (i in seq_along(single.spp.prioritisations))
	grid.FPLY@data[[paste0('Single-species (equal costs).', c('Amount', 'Surrogate', 'Genetic')[i])]] <- rowMeans(sapply(single.spp.prioritisations[[i]], function(x){colMeans(x@results@selections)}))
for (i in seq_along(multi.spp.prioritisations))
	grid.FPLY@data[[paste0('Multi-species (equal costs).', c('Amount', 'Surrogate', 'Genetic')[i])]] <- colMeans(multi.spp.prioritisations[[i]]@results@selections)
for (i in seq_along(multi.spp.prioritisations.with.cost))
	grid.FPLY@data[[paste0('Multi-species (opportunity costs).', c('Amount', 'Surrogate', 'Genetic')[i])]] <- colMeans(multi.spp.prioritisations.with.cost[[i]]@results@selections)
grid.FPLY <- spFortify(grid.FPLY)
grid.FPLY <- grid.FPLY %>% gather(
		Combination,
		`Selection.Frequency`,
		`Single-species (equal costs).Amount`:`Multi-species (opportunity costs).Genetic`
	) %>% mutate(
		Context=sapply(strsplit(as.character(Combination), '.', fixed=TRUE), `[[`, 1),
		Prioritization=sapply(strsplit(as.character(Combination), '.', fixed=TRUE), `[[`, 2)
	) %>% mutate(
		Prioritization=factor(Prioritization, levels=c('Amount', 'Surrogate', 'Genetic')),
		Context=factor(
			gsub(' (', '\n(', Context, fixed=TRUE),
			levels=c("Single-species\n(equal costs)", "Multi-species\n(equal costs)", 
			"Multi-species\n(opportunity costs)"))
	)
panel.DF <- grid.FPLY %>% select(Context, Prioritization, long, lat) %>% 
	mutate(
		lat=min(lat)+(diff(range(lat))*0.98),
		long=min(long)+(diff(range(long))*0.02)
	) %>%
	group_by(Context,Prioritization) %>% filter(c(TRUE, rep(FALSE, length(Context)-1))) %>%
	mutate(
		panel.letter=paste0('(',letters[(as.integer(Context)-1)*3 + as.integer(Prioritization)],')'),
		panel.letter=c(as.character(panel.letter[1]), rep(NA_character_, length(Context)-1))
	)
# make maps
ggplot() +
	geom_polygon(data=countries.FPLY, aes(x=long, y=lat, group=group),
		fill='grey85', color='grey70') +
	geom_polygon(data=grid.FPLY, aes_string(x='long', y='lat', 
		group='group', fill='Selection.Frequency'),
		alpha=0.8, color='grey10') +
	geom_text(aes_string(x='long',y='lat', label='panel.letter'), data=panel.DF) +
	theme_classic() +
	theme(axis.ticks=element_blank(), axis.text=element_blank(),
		plot.margin=unit(c(0,0,0,0),'cm'), axis.line=element_blank(),
		strip.background = element_rect(fill='grey20'),
		strip.text = element_text(color='white'),
		legend.position='bottom', legend.key.width=unit(1.8, 'cm'),
		legend.title=element_text(vjust=-5),
		legend.margin=unit(c(0.1), 'cm'),
		axis.title=element_blank()) +
	coord_cartesian(
		xlim=buffered.range(grid.FPLY$long, 0),
		ylim=buffered.range(grid.FPLY$lat, 0)
	) +
	facet_grid(Context ~ Prioritization) +
	scale_fill_gradientn(name='Selection Frequency (%)',
		colors=brewer.pal(9, 'PuBu'),
		guide=guide_colorbar(title.position='bottom', title.hjust=0.5,
			ticks=element_line(color='black'), border=element_line(color='black'))
	)
```

```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.width=5, fig.height=5, fig.cap='The effectiveness of prioritizations at securing genetic variation. The top row of panels (a--b) show the performance of single-species prioritizations generated assuming equal costs among planning costs. The middle row of panels (c--d) show the performance of multi-species prioritizations generated assuming equal costs among planning units. The bottom row of panels (e--f) show the performance of multi-species prioritizations generated using opportunity costs. The left column of panels (a, c, d) and the right column of panels (b, d, f) show the proportion of adaptive and neutral genetic variation secured (respectively). Box plots show the effectiveness of prioritizations generated using amount-based targets, amount-based and surrogate-based targets, and amount-based and genetic-based targets for each species. Letters denote significant differences ($P < 0.05$).'}
# prepare data for plotting
results.SDF <- results.SDF %>% mutate(
		Prioritisation=factor(as.character(Prioritisation), levels=c('Amount','Surrogate','Genetic')),
		Context=factor(as.character(Context), levels=c("single-species (equal costs)", "multi-species (equal costs)", "multi-species (opportunity costs)")),
		Metric=factor(as.character(Metric), c("Adaptive variation", "Neutral variation"))
	)
results.PDF <- results.SDF %>% group_by(
		Prioritisation, Context, Metric
	) %>% mutate(
		letter.height=max(value, na.rm=TRUE)+0.04,
		Combination=paste0(Prioritisation,'.',Metric,'.',Context)
	) %>% filter(
		c(TRUE, rep(FALSE, length(Context)-1))
	) %>% data.frame() %>% group_by(Context, Metric) %>% mutate(
		panel.letter=paste0('(',letters[as.integer(Context) + (as.integer(Metric)-1)],')'),
		panel.letter=c(as.character(panel.letter[1]), rep(NA_character_, length(Context)-1))
	) %>% data.frame() %>% left_join(
		data.frame(
			letter=unname(toupper(cld(posthoc.model.GLHT)$mcletters$Letters)),
			Combination=as.character(names(toupper(cld(posthoc.model.GLHT)$mcletters$Letters)))
		) %>% mutate(Combination=as.character(Combination)),
		by='Combination'
	) %>% data.frame()
results.SDF <- results.SDF %>% mutate(
	Context=sapply(as.character(Context), function(x) {paste0(toupper(substr(x, 1, 1)), substr(x, 2, nchar(x)))}),
	Context=factor(
		gsub(' (', '\n(', Context, fixed=TRUE),
		levels=c("Single-species\n(equal costs)",
		"Multi-species\n(equal costs)", 
		"Multi-species\n(opportunity costs)"))
	)
results.PDF <- results.PDF %>% mutate(
	Context=sapply(as.character(Context), function(x) {paste0(toupper(substr(x, 1, 1)), substr(x, 2, nchar(x)))}),
	Context=factor(
		gsub(' (', '\n(', Context, fixed=TRUE),
		levels=c("Single-species\n(equal costs)",
		"Multi-species\n(equal costs)", 
		"Multi-species\n(opportunity costs)"))
	)
# make plot
suppressWarnings({
	ggplot(aes(x=Prioritisation,y=value),
		data=results.SDF) +
		geom_boxplot(position=position_dodge(0.9)) +
		geom_text(aes(x=Prioritisation, y=letter.height, label=letter),
			data=results.PDF, position=position_dodge(0.9)) +
		geom_text(aes(x=0.6, y=1.03, label=panel.letter),
			data=results.PDF) +
		scale_fill_manual(name='Prioritisation',
			values=c('grey80','grey50','grey20')) +
		ylab('Genetic variation secured (%)') +
		xlab('') +
		ylim(c(NA, 1.05)) +
		theme_classic() +
		theme(strip.background = element_rect(fill='grey20'),
			strip.text = element_text(color='white'),
			panel.border = element_rect(color='black', fill=NA),
			axis.text.x=element_text(angle=45, hjust=1, vjust=1)) +
		facet_grid(Context ~ Metric)
})
```

